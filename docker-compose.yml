version: '3.4'
services:
  db:
    image: mysql/mysql-server:latest
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    volumes:
        - type: bind
          source: .\mysql\dump
          target: /docker-entrypoint-initdb.d/
    environment:
      MYSQL_ROOT_USER: root
      MYSQL_ROOT_PASSWORD: EqxM9tuOOsocoj
      MYSQL_DATABASE: dcsm
      MYSQL_USER: dcsm
      MYSQL_PASSWORD: dcsm
      TZ: "Europe/Moscow"
    ports:
      - 3309:3306
    container_name: mysql
    
  es01:
    image: elasticsearch:7.9.2
    environment:
      - "ES_JAVA_OPTS=-Xms200m -Xmx2000m"
      - "TZ=Europe/Moscow"
      - discovery.type=single-node
      - node.name=es01
    restart: unless-stopped
    container_name: es01
    volumes:
      - ./docker-data/es/:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
      
  cerebro:
    image: lmenezes/cerebro
    restart: unless-stopped
    ports:
      - 9000:9000
      
  nginx-api:
    image: nginx:1.21.3
    #image: arm64v8/nginx
    container_name: nginx-api-messenger
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 80:80
    volumes:
      - ./deploy/03-nginx/nginx.conf:/etc/nginx/nginx.conf:ro

  envoy:
    image: envoyproxy/envoy-dev:affac20e5089c4725eeb0f2de486b6580a07052d
    container_name: envoy-proxy
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 10000:10000
    volumes:
      - ./deploy/04-envoy/envoy.yaml:/etc/envoy/envoy.yaml
        
  mes-registration-service:
    build:
        context: ./src/dotnet
        dockerfile: Messenger.RegistrationServer/Dockerfile
    command: dotnet Messenger.RegistrationServer.dll
    container_name: mes-registration
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 23580:23580
    volumes:
      - ./docker-data/logs/registration-service:/app/logs/
      - ./docker-data/secrets/jwt_secret.secret:/app/jwt_secret.secret:ro
      - ./docker-data/secrets/mysql_secrets.json:/app/mysql_secrets.json:ro
        
  mes-auth-service:
    build:
        context: ./src/dotnet
        dockerfile: Messenger.AuthServer/Dockerfile
    command: dotnet Messenger.AuthServer.dll
    container_name: mes-auth
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 23581:23581
    volumes:
      - ./docker-data/logs/auth-service:/app/logs/
      - ./docker-data/secrets/jwt_secret.secret:/app/jwt_secret.secret:ro
      - ./docker-data/secrets/mysql_secrets.json:/app/mysql_secrets.json:ro
        
  mes-user-service:
    build:
        context: ./src/dotnet
        dockerfile: Messenger.UserServer/Dockerfile
    command: dotnet Messenger.UserServer.dll
    container_name: mes-user
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 23582:23582
    volumes:
      - ./docker-data/logs/user-service:/app/logs/
      - ./docker-data/secrets/jwt_secret.secret:/app/jwt_secret.secret:ro
      - ./docker-data/secrets/mysql_secrets.json:/app/mysql_secrets.json:ro
        
  mes-chat-info-service:
    build:
        context: ./src/dotnet
        dockerfile: Messenger.ChatInfoServer/Dockerfile
    command: dotnet Messenger.ChatInfoServer.dll
    container_name: mes-chat-info
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 23578:23578
    volumes:
      - ./docker-data/logs/chat-info-service:/app/logs/
      - ./docker-data/secrets/jwt_secret.secret:/app/jwt_secret.secret:ro
      - ./docker-data/secrets/mysql_secrets.json:/app/mysql_secrets.json:ro
        
  mes-messenger-service:
    build:
        context: ./src
        dockerfile: dotnet/Messenger.MessengerServer/Dockerfile
    command: dotnet Messenger.MessengerServer.dll
    container_name: mes-messenger-info
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 23579:23579
      - 7813:7813
    volumes:
      - ./docker-data/logs/messenger-service:/app/logs/
      - ./docker-data/secrets/jwt_secret.secret:/app/jwt_secret.secret:ro
      - ./docker-data/secrets/mysql_secrets.json:/app/mysql_secrets.json:ro
        
  mes-orchestrator-service:
    build:
        context: ./src/dotnet
        dockerfile: Messenger.Orchestrator/Dockerfile
    command: dotnet Messenger.Orchestrator.dll
    container_name: mes-orchestrator
    restart: unless-stopped
    environment:
      TZ: "Europe/Moscow"
    ports:
      - 23583:23583
    volumes:
      - ./docker-data/logs/orchestrator-service:/app/logs/
      - ./docker-data/secrets/jwt_secret.secret:/app/jwt_secret.secret:ro
      - ./docker-data/secrets/mysql_secrets.json:/app/mysql_secrets.json:ro
